<!doctype html>
<html>
  <head>
    <title>Drawing game</title>
    <style>
      body { font: 13px Helvetica, Arial; }
      #sketches { list-style-type: none; margin: 0; padding: 0; }
      #sketches li { padding: 5px 10px; }
      #sketches li:nth-child(odd) { background: #eee; }
      #sketch {display: block; margin: 5px; border-style: solid; border-width: 5px; }
    </style>
  </head>
  <body>
    <div id="login_page">
      <button id="new_game">New game</button><div id="current_game"></div>
      <ul id="players"></ul>
      <input type="text" id="player_name" placeholder="Name...">
      <input type="text" id="room_code" placeholder="Room code">
      <button id="new_player">Add player</button>
    </div>
    <div id="sketch_page" style="visibility: hidden">
      <ul id="sketches"></ul>
      <canvas id="sketch" width="800px" height="800px"></canvas>
      <button id="submit">Submit</button>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var socket = io();

      var $new_g = $('#new_game');
      var $new_p = $('#new_player');

      $new_g.click(function(){
        socket.emit('new game');
      });

      socket.on('new game', function(code){
        $('#current_game').text(code);
      });

      $new_p.click(function(){
        var player_info = {name: $('#player_name').val(), room_code: $('#room_code').val()};
        socket.emit('new player', player_info);
        $('#player_name').val('');
      });

      socket.on('new player', function(name){
        $('#players').append($('<li>').text(name));
      });


      //handles drawing
      var clickX = new Array();
      var clickY = new Array();
      var clickDrag = new Array();
      var paint;
      var $canvas = $('#sketch');
      var context = $canvas[0].getContext("2d");

      //set context and canvas width to the width of the window
      context.canvas.width = $canvas[0].width = window.innerWidth - 36;

      function addClick(x,y,dragging){
        clickX.push(x);
        clickY.push(y);
        clickDrag.push(dragging);
      }

      function redraw(){
        context.clearRect(0, 0, context.canvas.width, context.canvas.height);
        context.strokeStyle = "#df4b26";
        context.lineJoin = "round";
        context.lineWidth = 5;

        for(var i=0; i< clickX.length; i++){
          context.beginPath();
          if(clickDrag[i] && i){
            context.moveTo(clickX[i-1], clickY[i-1]);
          } else {
            context.moveTo(clickX[i]-1, clickY[i]);
          }

          context.lineTo(clickX[i], clickY[i]);
          context.closePath();
          context.stroke();
        }
      }

      $canvas.mousedown(function(e){
        var mouseX = e.pageX - this.offsetLeft;
        var mouseY = e.pageY - this.offsetTop;

        paint = true;
        addClick(mouseX, mouseY);
        redraw();
      });

      $canvas.mousemove(function(e){
        if(paint){
          var mouseX = e.pageX - this.offsetLeft;
          var mouseY = e.pageY - this.offsetTop;
          addClick(mouseX, mouseY, true);
          redraw();
        }
      });

      $canvas.mouseup(function(e){
        paint = false;
      });

      $canvas.mouseleave(function(e){
        paint = false;
      });

      $('#submit').click(function(e){
        var dataURL = $('#sketch')[0].toDataURL('image/png');
        socket.emit('new image', dataURL);
      });

      socket.on('new image', function(img){
        var newImg = $('<img>').attr('src', img);
        $('#sketches').append($('<li>').append(newImg));
      });

    </script>
  </body>
</html>