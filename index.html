<!doctype html>
<html lang="en">
  <head>
    <title>Drawing game</title>
    <style>
      body { font: 13px Helvetica, Arial; overflow: hidden; }
      .hidden { visibility: hidden; }
      .page_header { font-size: 4vw; }
      .center { text-align: center; }
      .add_player { width: 80vw; max-width: 1200px;}
      .add_player label { text-size: 10vh; }
      .input-group {display: block !important;}
      #new_player { margin-top: 5px; }
      #new_game { right: 0; position: absolute;}
      #sketches { list-style-type: none; margin: 0; padding: 0; }
      #sketches li { padding: 5px 10px; }
      #sketches li:nth-child(odd) { background: #eee; }
      #sketch {display: block; margin: 5px; border-style: solid; border-width: 5px; }
      #ready_players img { width: 150px; height:150px; }
    </style>
    <link rel="stylesheet" type="text/css" href="/bs/css/bootstrap.css">
  </head>
  <body>
    <div id="login_page">
      <header>
        <button class="right" id="new_game">New game</button>
        <div class="page_header center">Login</div>
      </header>
      
      <ul id="players"></ul>
      <div class="add_player center-block">
        <div id="current_game"></div>
        <div class="input-group input-group-lg">
          <label>Room Code</label>
          <input type="text" class="form-control" id="room_code" placeholder="Room code" maxlength="4">
        </div>
        <br>
        <div class="input-group input-group-lg">
          <label>Name</label>
          <input type="text" class="form-control" id="player_name" placeholder="Name..." maxlength="12">
        </div>
        <button id="new_player" class="btn btn-primary">Play</button>
      </div>
    </div>
    <div id="sketch_page" class="hidden">
      <ul id="ready_players"></ul> 
      <canvas id="sketch" width="800px" height="800px"></canvas>
      <button id="sketch_submit">Submit</button>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var socket = io();

      var $new_g = $('#new_game');
      var $new_p = $('#new_player');

      $new_g.click(function(){
        socket.emit('new game');
      });

      socket.on('new game', function(code){
        $('#current_game').text(code);
      });

      $new_p.click(function(){
        var player_info = {name: $('#player_name').val(), room_code: $('#room_code').val()};
        socket.emit('new player', player_info);
        $('#player_name').val('');
      });

      socket.on('new player', function(name){
        // $('#players').append($('<li>').text(name));
        $('#login_page').addClass('hidden');
        $('#sketch_page').removeClass('hidden');
        $('#sketch').attr('player', name);
      });

      socket.on('player ready', function(player){
        var $player_item = $('<li>').append($('<img>').attr('src', player.picture)).append($('<div>').text(player.name));
        $('#ready_players').append($player_item);
      });

      $('#sketch_submit').click(function(e){
        var dataURL = $('#sketch')[0].toDataURL('image/png');
        var is_player = $('#sketch').attr('player');
        //submitting a player picture
        if(is_player){
          var player_sketch = {name: is_player, player_picture: dataURL, room_code: $('#room_code').val() };
          socket.emit('player picture', player_sketch);
        } else {
          socket.emit('new image', dataURL);
        }
      });

      socket.on('new image', function(img){
        var newImg = $('<img>').attr('src', img);
        $('#sketches').append($('<li>').append(newImg));
      });

      function detect_device_type(){
        if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          return "mobile";
        } else {
          return "desktop";
        }
      }


      //handles drawing
      var clickX = [];
      var clickY = [];
      var clickDrag = [];
      var paint;
      var $canvas = $('#sketch');
      var context = $canvas[0].getContext("2d");

      //set context and canvas width to the width of the window
      context.canvas.width = $canvas[0].width = window.innerWidth - 36;

      function add_click(x,y,dragging){
        clickX.push(x);
        clickY.push(y);
        clickDrag.push(dragging);
      }

      function redraw(){
        context.clearRect(0, 0, context.canvas.width, context.canvas.height);
        context.strokeStyle = "#df4b26";
        context.lineJoin = "round";
        context.lineWidth = 5;

        for(var i=0; i< clickX.length; i++){
          context.beginPath();
          if(clickDrag[i] && i){
            context.moveTo(clickX[i-1], clickY[i-1]);
          } else {
            context.moveTo(clickX[i]-1, clickY[i]);
          }

          context.lineTo(clickX[i], clickY[i]);
          context.closePath();
          context.stroke();
        }
      }

      var eventDown = function(e){
        var mouseX = e.pageX - this.offsetLeft;
        var mouseY = e.pageY - this.offsetTop;

        paint = true;
        add_click(mouseX, mouseY);
        redraw();
      };

      var eventMove = function(e){
        if(paint){
          var mouseX = e.pageX - this.offsetLeft;
          var mouseY = e.pageY - this.offsetTop;
          add_click(mouseX, mouseY, true);
          redraw();
        }
      };

      var stopPainting = function(e){
        paint = false;
      };

      if(detect_device_type() === 'mobile') { // touch for mobile
        $canvas.touchstart(eventDown);
        $canvas.touchmove(eventMove);
        $canvas.touchend(stopPainting);
        $canvas.touchleave(stopPainting);
      } else{ //click for pc
        $canvas.mousedown(eventDown);
        $canvas.mousemove(eventMove);
        $canvas.mouseup(stopPainting);
        $canvas.mouseleave(stopPainting);
      }

    </script>
  </body>
</html>